schemaVersion: 2.0
timeout: 240

notify:
  pullRequestComment:
    postOnSuccess: false

machine:
  env:
    RUNTIME_JDK_VERSION: 11
    skipTest: false
    CODE_VERSION: $(./code_version.sh)
    GRADLE_LOG_LEVEL: INFO
    CI_HOOKS: ./ci_hooks
    baseImage: docker.apple.com/base-images/ubi8/java11-builder

jenkins:
  concurrentBuild: true
  maxConcurrentTotal: 8

reports:
  checkstyle: true
  pmd: true
  findbugs: true
  junit: true

pipelines:

# prb builds
- branchName: aiml-flink-1.4.x-release-prb
  build:
    template: buildozer:v4:prb

# publish pipelines
- branchName: aiml-flink-1.4.x-release
  build:
    template: buildozer:v4:publish
  package:
    release: true
    libraries:
    - publish:
      - repo: m2:oss-patched
  finally:
    radar:
      annotate: true
    tag:
      expression: ${CODE_VERSION}

- branchName: enumerator-metrics-preview
  build:
    template: freestyle:v4:publish
    steps:
      # Modules flink depends on
      # Generated by:
      #   ./gradlew iceberg-flink:iceberg-flink-runtime-1.18:dependencies >/tmp/dep
      #   for i in `grep iceberg /tmp/dep|cut -d ':' -f 2|sort|uniq|grep -v '\*'|grep -v project`;do echo -n ":${i}:build ";done
      - ./gradlew :iceberg-aliyun:build :iceberg-api:build :iceberg-aws:build :iceberg-bundled-guava:build :iceberg-common:build :iceberg-core:build :iceberg-data:build :iceberg-flink:build :iceberg-hive-metastore:build :iceberg-nessie:build :iceberg-orc:build :iceberg-parquet:build
      # The build and test of the flink jars
      - ./gradlew :iceberg-flink:iceberg-flink-1.17:build -Dorg.gradle.jvmargs=-Xmx4096M
      # The build and test of the runtime jars
      - ./gradlew :iceberg-flink:iceberg-flink-runtime-1.17:build -Dorg.gradle.jvmargs=-Xmx4096M
      - home_dir=$(pwd)
      # Publish the jars to a local repo
      # Modules flink depends on
      # Generated by:
      #   ./gradlew iceberg-flink:iceberg-flink-runtime-1.18:dependencies >/tmp/dep
      #   for i in `grep iceberg /tmp/dep|cut -d ':' -f 2|sort|uniq|grep -v '\*'|grep -v project`;do echo -n ":${i}:publishToMavenLocal ";done
      - ./gradlew -PreleaseBuild=true -Dmaven.repo.local=${home_dir}/local-repo :iceberg-aliyun:publishToMavenLocal :iceberg-api:publishToMavenLocal :iceberg-aws:publishToMavenLocal :iceberg-bundled-guava:publishToMavenLocal :iceberg-common:publishToMavenLocal :iceberg-core:publishToMavenLocal :iceberg-data:publishToMavenLocal :iceberg-flink:publishToMavenLocal :iceberg-hive-metastore:publishToMavenLocal :iceberg-nessie:publishToMavenLocal :iceberg-orc:publishToMavenLocal :iceberg-parquet:publishToMavenLocal
      # Publish the flink jars to a local repo
      - ./gradlew -PreleaseBuild=true -Dmaven.repo.local=${home_dir}/local-repo iceberg-flink:iceberg-flink-1.17:publishToMavenLocal
      # Publish the runtime jars to a local repo
      - ./gradlew -PreleaseBuild=true -Dmaven.repo.local=${home_dir}/local-repo :iceberg-flink:iceberg-flink-runtime-1.17:publishToMavenLocal
      # Publish the jars for the local repo
      - ci stage-lib --many-many-artifacts "./local-repo/**/*.jar"
      - ci stage-lib --many-many-artifacts "./local-repo/**/*.pom"
  package:
    release: true
    freeform:
      - publish:
          - repo: m2:oss-patched
  finally:
    radar:
      annotate: true
    tag:
      expression: ${CODE_VERSION}
